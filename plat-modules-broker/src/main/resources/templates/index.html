<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOT Broker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .node-card {
            width: 280px;
            height: 150px;
            border: solid 1px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
            padding-right: 50px;
            margin-right: 30px;
        }

        .refresh_btn {
            width: 100px;
            height: 40px;
            border-radius: 5px;
            margin-top: 20px;
            float: end;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center" style="padding-bottom: 10px">ğŸ“¡ IOT Broker</h2>
    <div id="statistics" style="display: flex;justify-content: space-between; margin-bottom: 20px">
        <div style="display: flex;justify-content: flex-start">
            <div class="node-card">
                <p style="margin-left: 30px;margin-top: 15px;font-size: 25px; font-weight: bolder">é›†ç¾¤</p>
                <div style="padding-top: 1px">
                    <p style="text-align: right; margin-bottom:1px;font-weight: bold">--</p>
                </div>
            </div>
            <div class="node-card">
                <p style="margin-left: 30px;margin-top: 15px;font-size: 25px; font-weight: bolder">è¿æ¥</p>
                <p style="text-align: right; margin-top:40px;font-size: 20px;font-weight: bold">æ€»æ•°: 0</p>
            </div>
            <div class="node-card">
                <p style="margin-left: 30px;margin-top: 15px;font-size: 25px; font-weight: bolder">è®¢é˜…</p>
                <p style="text-align: right; margin-top:40px;font-size: 20px;font-weight: bold">æ€»æ•°: 0</p>
            </div>
        </div>
        <button class="refresh_btn" onclick="refreshAll()">åˆ·æ–°</button>
    </div>


    <table id="deviceTable" class="table table-striped mt-3">
        <input type="text" id="searchInput" style="width: 300px;border-radius: 5px"
               placeholder="è¾“å…¥ç»ˆç«¯ ID è¿›è¡Œæœç´¢...">
        <button id="search" style="border-radius: 5px;margin-left: 3px" onclick="searchSessions()">search</button>
        <thead>
        <tr>
            <th>ç»ˆç«¯ ID</th>
            <th>çŠ¶æ€</th>
            <th>ç”¨æˆ·å</th>
            <th>å¿ƒè·³</th>
            <th>ä¼šè¯çŠ¶æ€</th>
            <th>è¿æ¥æ—¶é—´</th>
            <th>èŠ‚ç‚¹ID</th>
            <th>IPåœ°å€</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    function refreshAll() {
        initStatistics();
        searchSessions();
    }

    function searchSessions() {
        let keyword = document.getElementById("searchInput").value;
        fetch(`/api/sessions/search?keyword=${keyword}`)
            .then(response => response.json())
            .then(data => {
                let dataRow = "";
                data.forEach(client => {
                    let onlineTime = formatDate(client.onlineTime)
                    let row = `<tr>
                        <td >${client.clientId}</td>
                        <td >å·²è¿æ¥</td>
                        <td >${client.username}</td>
                        <td >${client.keepAlive}s</td>
                        <td >${client.cleanSession ? 'ä¸´æ—¶ä¼šè¯' : 'æŒä¹…ä¼šè¯'}</td>
                        <td >${onlineTime}</td>
                        <td >${client.nodeId}</td>
                        <td >127.0.0.1[X]</td>
                    </tr>`;
                    dataRow += row;
                });
                document.querySelector("#deviceTable tbody").innerHTML = dataRow;
            });
    }

    function formatDate(time) {
        return new Date(time).toLocaleString().replace(/\//g, "-");
    }

    function getClusterList(callback) {
        fetch(`/api/node/list`)
            .then(response => response.json())
            .then(data => {
                callback(data)
            });
    }

    function getClientTotal(callback) {
        fetch(`/api/sessions/total`)
            .then(response => response.json())
            .then(data => {
                callback(data)
            });
    }

    function getSubscriptionTotal(callback) {
        fetch(`/api/subscriptions/total`)
            .then(response => response.json())
            .then(data => {
                callback(data)
            });
    }

    function initStatistics() {
        getClusterList(data => {
            // æ›´æ–°é›†ç¾¤åˆ—è¡¨
            const clusterContainer = document.querySelector('.node-card:first-child div');
            clusterContainer.innerHTML = ""; // æ¸…ç©ºæ—§æ•°æ®
            data.forEach(node => {
                const p = document.createElement('p');
                p.textContent = `${node.nodeId}`;
                p.style.textAlign = 'right';
                p.style.marginBottom = '1px';
                p.style.fontWeight = 'bold';
                clusterContainer.appendChild(p);
            });
        });
        getClientTotal(data => {
            // æ›´æ–°è¿æ¥æ€»æ•°
            document.querySelector('.node-card:nth-child(2) p:last-child').innerHTML = `æ€»æ•°: ${data}`;
        });
        getSubscriptionTotal(data => {
            // æ›´æ–°è®¢é˜…æ€»æ•°
            document.querySelector('.node-card:nth-child(3) p:last-child').innerHTML = `æ€»æ•°: ${data}`;
        });
    }

    refreshAll();
    // å¯åŠ¨å®šæ—¶ä»»åŠ¡åˆ·æ–°é¡µé¢æ•°æ®
    setInterval(() => refreshAll(), 10000)
</script>
</body>

</html>
